# Test schema/lint action for TeamCity
# Mock the atlas command outputs
env ATLAS_PATH=$MOCK_ATLAS TEST_BATCH=./schema-lint
# Setup the action input variables
env ATLAS_INPUT_URL=file://schema.hcl
env ATLAS_INPUT_DEV_URL=sqlite://file?mode=memory

# Run schema lint action - expect success with warnings
atlas-action --action=schema/lint
cmp stdout out
-- schema-lint/1/args --
schema lint --format {{ json . }} --dev-url sqlite://file?mode=memory --url file://schema.hcl
-- schema-lint/1/stdout --
{"Steps":[{"Text":"naming","Diagnostics":[{"Pos":{"Filename":"schema.hcl","Start":{"Line":5}},"Text":"Table name should use snake_case","Code":"NM101"}]}]}
-- out --
##teamcity[buildStatisticValue key='atlas.schema.lint.steps' value='1']
##teamcity[buildStatisticValue key='atlas.schema.lint.diagnostics' value='1']
##teamcity[buildStatisticValue key='atlas.schema.lint.errors' value='0']
##teamcity[addBuildTag 'schema-lint-issues']
##teamcity[buildStatus text='{build.status.text}, schema lint found 1 issue(s) in 1 step(s)']
##teamcity[blockOpened description='file://schema.hcl' flowId='schema-lint' name='atlas schema lint']
##teamcity[inspectionType category='atlas' description='Schema lint checks' flowId='schema-lint' id='atlas-schema-lint' name='Atlas Schema Lint']
##teamcity[message flowId='schema-lint' status='WARNING' text='naming ']
##teamcity[inspection SEVERITY='WARNING' file='schema.hcl' flowId='schema-lint' line='5' message='<a href="https://atlasgo.io/lint/analyzers#NM101">Table name should use snake_case</a>' typeId='atlas-schema-lint']
##teamcity[blockClosed flowId='schema-lint' name='atlas schema lint']
##teamcity[message status='NORMAL' text='`atlas schema lint` completed successfully with 1 warnings, check the annotations for details']
