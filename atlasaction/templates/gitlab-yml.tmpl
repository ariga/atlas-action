# Generated by go run ./cmd/gen gitlab-template; DO NOT EDIT.
spec:
  inputs:
    job_name:
      description: The name of the job.
      default: {{ .ID | replace "/" "-" | printf "atlas-%s" }}
    stage:
      description: The CI stage to run the job in.
      default: ""
    atlas-version:
      description: Install a specific Atlas version.
      default: latest
    gitlab-token:
      description: A Gitlab access token for posting merge request comments.
      default: ""
{{- if ne .ID "monitor/schema" }}
    atlas-cloud-token:
      description: A token for Atlas Cloud.
      default: ""
{{- end }}
{{- range $name, $input := .SortedInputs }}
    {{ $name }}:
      type: {{ $input.Type }}
      description: {{ $input.Description | yaml 8 | trimnl }}{{ with $input.Default }}
      default: {{ . }}{{ else }}{{ if not .Required }}
      default: {{ if eq $input.Type "number" }}0{{ else }}""{{ end }}
      {{- end }}{{ end }}
    {{- with .Options }}
      options:
        {{- if and (eq $input.Default "") (not $input.Required) }}
        - ""
        {{- end }}
        {{- range $v := . }}
        - {{ $v }}
        {{- end }}
    {{- end }}
{{- end }}

---
$[[ inputs.job_name ]]:
  stage: $[[ inputs.stage ]]
  before_script:
    - |
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache curl
      elif command -v apt >/dev/null 2>&1; then
        apt update -q && apt install -y curl
      else
        echo "Unsupported OS: neither apk nor apt found"
        exit 1
      fi
      curl -sSf https://atlasgo.sh | ATLAS_VERSION="$[[ inputs.atlas-version ]]" sh
{{- if ne .ID "monitor/schema" }}
      atlas login --token $[[ inputs.atlas-cloud-token ]]
{{- end }}
      curl -o atlas-action https://release.ariga.io/atlas-action/atlas-action-v1
      chmod +x ./atlas-action
{{- if eq .ID "migrate/diff" }}
      # Set up git
      git fetch $[[ inputs.remote ]] $CI_COMMIT_REF_NAME
      git config --global user.email "gitlab-ci@users.noreply.gitlab.com"
      git config --global user.name "GitLab CI"
      git remote set-url $[[ inputs.remote ]] "https://oauth2:$[[ inputs.gitlab-token ]]@$CI_SERVER_HOST/$CI_PROJECT_PATH.git"
{{- end }}
  script:
    - ./atlas-action --action={{ .ID }}
  variables:
    GITLAB_TOKEN: $[[ inputs.gitlab-token ]]
{{- range $name, $input := .SortedInputs }}
    {{ $name | inputvar }}: $[[ inputs.{{ $name }} ]]
{{- end }}
{{- if .Outputs }}
  artifacts:
    reports:
      dotenv: .env
{{- end }}
{{- if or (eq .ID "migrate/diff") (eq .ID "migrate/lint") }}
  rules:
    - if: "$CI_MERGE_REQUEST_IID"
      when: always
{{- else if eq .ID "monitor/schema" }}
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: on_success
    - when: manual
{{- end }}
